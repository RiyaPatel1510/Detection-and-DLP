[Detect: Suspicious PowerShell Download Cradle]
action.email=0
action.notable=1
action.notable.param.rule_title=Suspicious PowerShell Download Cradle
action.notable.param.nes_fields=host,user,img
action.notable.param.severity=high
action.notable.param.threat_object_type=process
action.notable.param.threat_object=img
action.notable.param.threat_activity=Suspicious Download Cradle
action.notable.param.annotations={"mitre_technique":"T1059.001,T1105"}
cron_schedule=*/5 * * * *
search = index=win* (sourcetype="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" OR sourcetype="XmlWinEventLog:Security") 
  | eval cmd=coalesce(CommandLine, process_command_line) 
  | eval img=coalesce(Image, process_path) 
  | where like(lower(img), "%\\powershell.exe") OR like(lower(img), "%\\pwsh.exe") 
  | where match(lower(cmd), "invoke-webrequest|downloadstring|invoke-expression|start-bitstransfer|new-object\s+net\.webclient|iex\(") 
  | stats count min(_time) as first_seen max(_time) as last_seen by host, user, img, cmd, ParentImage, ParentCommandLine 
  | where count>=1
